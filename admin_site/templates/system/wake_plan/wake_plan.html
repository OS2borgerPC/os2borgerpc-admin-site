{% extends "system/wake_plan/wake_plan_base.html" %}
{% load crispy_forms_tags %}

{% block specific_content %}

<div class="container-fluid main sublevelmain">

  <h1 class="divideheader">{{selected_plan.name|default:"Ny Tænd/Sluk tidsplan"}}</h1>
  {% include 'notification.html' %}

  {# Here we insert templates for the two types of wake change events that javascript can then copy when the buttons to add them are clicked #}
  {# We add them outside the form, because otherwise the webpage tries to validate their contents and it fails #}
  <div id="wake-change-event-altered-hours-form" class="d-none">{{wake_change_event_altered_hours_form}}</div>
  <div id="wake-change-event-closed-form" class="d-none">{{wake_change_event_closed_form}}</div>

  <form method="post" class="gray-box">

    {% csrf_token %}
    <div class="container-fluid">

      <div class="alert alert-info">
        <p><strong>Bemærk</strong></p>
        <ul>
          <li>
            En Gruppe kan kun være i én Tidsplan.
          </li>
          <li>
            Hvis der en given dag er åbent, skal både start- og sluttidspunkt være udfyldt. (IDÉ: kan dette punkt måske udelades
            hvis formularen bare sørger for det?)
          </li>
          <li>
            En Computer kan kun modtage en opdateret Tidsplan, når den er tændt.<br/>
            Dvs. at hvis Computeren er lukket ned for en given dag, og den derefter - fra adminsitet -
            gives en ny tidsplan, vil dette ikke tage effekt, før den tænder efter den oprindelige plan.
          </li>
          <li>
            Hvis en Tidsplan ikke har nogen tilføjede Grupper, eller er sat til
            inaktiv, vil den ikke have nogen effekt.
          </li>
          <li>
            Hvis Computeren slukkes på knappen, via menuen eller via et Script eller strømmen går, vil den <em>IKKE</em> vågne op og følge sin
            tidsplan.<br>
            Dvs. Computeren <em>SKAL</em> lukke ned af sig selv, som resultat af tidsplanen.<br/>
            Vi anbefaler derfor at scriptet <a href="TODO">Fjern "Luk ned" og "Genstart" fra sessionmenuen og blokér for
              nedlukning via systempolitik</a> køres på Computerne, så maskinen ikke længere kan lukkes ned fra menuen.
          </li>
          <li>
            Tidsplanen vil ikke længere fungere korrekt, hvis du samtidig benytter Scriptet <a href"TODO">Luk ned og
              vågn dagligt</a>.
          </li>
          <li>
            En Computer vil til enhver tid kunne tændes manuelt, hvis den ved en fejl er blevet lukket
            ned af Tænd/Sluk tidsplanen.
          </li>
          <li>
            Tidsplanen følger tiden <strong>på den individuelle maskine</strong>. Dvs. hvis uret på en maskine er ude af
            sync, så vil maskinen også opstarte og nedlukke ude af sync. Hvis I har en firewall der blokerer udadgående trafik, foreslår vi I
            åbner for <a href="https://en.wikipedia.org/wiki/Network_Time_Protocol" target="_blank">NTP</a> på port 123
            UDP, da det bruges til tidssynkronisering.
          </li>
          TODO: Tilføj info omkring dvale-scriptet!
        </ul>
      </div>

      <div class="row" style="margin-left: 0;">

        {# TODO: Verify that it works with the form errors #}
        {{form.errors}}

        <article class="col-lg-4 form-switch">

          {{form.enabled|as_crispy_field}}

          {{form.name|as_crispy_field}}

          {{form.sleep_state|as_crispy_field}}

          <p class="mt-4"><strong>Ugeplan</strong></p>
          <p>Konfigurer tænd og sluk for den faste ugeplan</p>
          <table id="week-plan" class="form-switch table">
            <thead>
              <tr>
                <td></td>
                <td></td>
                <td class="before-dash">Tænd</td>
                <td class="dash"></td>
                <td class="after-dash">Sluk</td>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>
                  <strong>Mandag</strong>
                </td>
                <td>
                  <input class="form-check-input fs-5 checkbox" type="checkbox" role="switch" id="monday-open" {% if selected_plan.monday_open %}checked{% endif %}><label class="form-check-label" for="monday-open">Tændt</label>
                </td>
                <td  class="before-dash">
                  {{form.monday_on}}
                </td>
                <td class="dash">—</td>
                <td class="after-dash">
                  {{form.monday_off}}
                </td>
              </tr>
              <tr>
                <td>
                  <strong>Tirsdag</strong>
                </td>
                <td>
                  <input class="form-check-input fs-5 checkbox" type="checkbox" role="switch" id="tuesday-open" {% if selected_plan.tuesday_open %}checked{% endif %}><label class="form-check-label" for="tuesday-open">Tændt</label>
                </td>
                <td  class="before-dash">
                  {{form.tuesday_on}}
                </td>
                <td class="dash">—</td>
                <td class="after-dash">
                  {{form.tuesday_off}}
                </td>
              </tr>
              <tr>
                <td>
                  <strong>Onsdag</strong>
                </td>
                <td>
                  <input class="form-check-input fs-5 checkbox" type="checkbox" role="switch" id="wednesday-open" {% if selected_plan.wednesday_open %}checked{% endif %}><label class="form-check-label" for="wednesday-open">Tændt</label>
                </td>
                <td  class="before-dash">
                  {{form.wednesday_on}}
                </td>
                <td class="dash">—</td>
                <td class="after-dash">
                  {{form.wednesday_off}}
                </td>
              </tr>
              <tr>
                <td>
                  <strong>Torsdag</strong>
                </td>
                <td>
                  <input class="form-check-input fs-5 checkbox" type="checkbox" role="switch" id="thursday-open" {% if selected_plan.thursday_open %}checked{% endif %}><label class="form-check-label" for="thursday-open">Tændt</label>
                </td>
                <td  class="before-dash">
                  {{form.thursday_on}}
                </td>
                <td class="dash">—</td>
                <td class="after-dash">
                  {{form.thursday_off}}
                </td>
              </tr>
              <tr>
                <td>
                  <strong>Fredag</strong>
                </td>
                <td>
                  <input class="form-check-input fs-5 checkbox" type="checkbox" role="switch" id="friday-open" {% if selected_plan.friday_open %}checked{% endif %}><label class="form-check-label" for="friday-open">Tændt</label>
                </td>
                <td  class="before-dash">
                  {{form.friday_on}}
                </td>
                <td class="dash">—</td>
                <td class="after-dash">
                  {{form.friday_off}}
                </td>
              </tr>
              <tr>
                <td>
                  <strong>Lørdag</strong>
                </td>
                <td>
                  <input class="form-check-input fs-5 checkbox" type="checkbox" role="switch" id="saturday-open" {% if selected_plan.saturday_open %}checked{% endif %}><label class="form-check-label" for="saturday-open">Tændt</label>
                </td>
                <td  class="before-dash">
                  {{form.saturday_on}}
                </td>
                <td class="dash">—</td>
                <td class="after-dash">
                  {{form.saturday_off}}
                </td>
              </tr>
              <tr>
                <td>
                  <strong>Søndag</strong>
                </td>
                <td>
                  <input class="form-check-input fs-5 checkbox" type="checkbox" role="switch" id="sunday-open" {% if selected_plan.sunday_open %}checked{% endif %}><label class="form-check-label" for="sunday-open">Tændt</label>
                </td>
                <td  class="before-dash">
                  {{form.sunday_on}}
                </td>
                <td class="dash">—</td>
                <td class="after-dash">
                  {{form.sunday_off}}
                </td>
              </tr>
            </tbody>
          </table>

        </article>

        <aside class="col-lg-8">
          <p class="mt-4"><strong>Lukkedage og undtagelser</strong></p>
          <p>Planlæg kommende lukkedage eller opret undtagelser fra den faste ugeplan</p>

          {# Wake events #}

          <table id="wake-change-events" class="table form-switch">
            <tbody>
              {#{% for ev_form in selected_plan.wake_change_events.all %}#}
              {% for ev, ev_form in wake_change_event_forms %}
                <tr>
                  <td>{{ev_form.name}}</td>
                  <td>{{ev_form.date_start}}</td>

                  <td>
                  {% if not ev.date_start == ev.date_end %} {# Used if it's a "period" #}
                    {{ev_form.date_end}}
                  {% endif %}
                  </td>

                  <td><input class="form-check-input fs-5 checkbox" type="checkbox" role="switch" id="event-{{ev.id}}" {% if ev.time_start %}checked{% endif %}></td>
                  <td><label class="form-check-label" for="event-{{ev.id}}">Tændt</label></td>

                  <td>
                    {% if ev.type == "ALTERED_HOURS" %}
                      <span class="before-dash">
                        {{ev_form.time_start}}
                      </span>
                      <span class="dash">—</span>
                      <span class="after-dash">
                        {{ev_form.time_end}}
                      </span>
                    {% endif %}
                  </td>
                  <td>
                    <span class="material-icons delete">delete_outline</span>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>

          <button class="btn" type="button"><span class="material-icons">date_range</span></span>Tilføj periode</button>
          <button class="btn" type="button"><span class="material-icons">today</span>Tilføj dato</button>

          <p class="mt-4 mb-0"><strong>Grupper der følger tidsplanen</strong></p>

          {# PCGroup picklist #}
          <fieldset class="col-12 col-lg-12">

            {{ form.groups.errors }}
            <div class="clearfix">
              <span class="badge bg-secondary picklist-counter-badge" style="float: right;">
                <span class="material-icons px-1">queue</span>
                <span id="total-groups"></span>
              </span>
            </div>
            {% include 'widgets/picklist.html' with submit_name='groups' selected_list=selected_groups available_list=available_groups identifier='gruppe' add_text='Tilføj gruppe til tidsplan' remove_text='Fjern computer fra tidsplan' site_url=site.uid target_section='groups' %}

          </fieldset>

        </aside>
      </div>
        <input class="btn btn-primary me-3" type="submit" name="submit" value="Gem ændringer">
        <input class="btn btn-secondary me-3" type="reset" name="cancel" value="Nulstil ændringer">
        {# Only show the button to duplicate a plan if you're updating an existing entry - not creating a new one#}
        {% if selected_plan.id %}
          <a class="btn btn-secondary" {% if wake_plan_access %} href="{% url 'wake_plan_copy' site.uid selected_plan.id %}" {% endif %}>Kopier tidsplan</a>
        {% endif %}
    </div>
    <hr>

    {{form|crispy}}
    <!-- {{form}} -->

    <input class="btn btn-primary me-3" type="submit" name="submit" value="Gem ændringer">
    <input class="btn btn-secondary" type="reset" name="cancel" value="Annuller">
    <input class="btn btn-secondary" type="submit" name="copy" value="Kopiér tidsplan">

  </form>

</div>

{% endblock %}
